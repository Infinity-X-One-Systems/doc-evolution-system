name: admin-sync

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  sync:
    name: Admin Control Plane Sync
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Run Admin Project Registration
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PLANE_PAT }}
          ORG: Infinity-X-One-Systems
          REPO: ${{ github.event.repository.name }}
        run: python org-sync/admin_project_register.py

      - name: Sync Memory Registry
        env:
          GIT_SHA: ${{ github.sha }}
          GIT_BRANCH: ${{ github.ref_name }}
        run: |
          python -c "
          import json, datetime, os
          try:
              registry = json.load(open('singularity/evolution/memory_registry.json'))
          except Exception:
              registry = {'entries': []}
          registry['entries'].append({
              'event': 'admin-sync',
              'timestamp': datetime.datetime.now(datetime.timezone.utc).isoformat().replace('+00:00', 'Z'),
              'ref': os.environ['GIT_SHA'][:8],
              'branch': os.environ['GIT_BRANCH']
          })
          json.dump(registry, open('singularity/evolution/memory_registry.json', 'w'), indent=2)
          print('Memory registry updated')
          "
